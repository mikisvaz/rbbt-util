#!/usr/bin/env ruby

require 'rbbt-util'
require 'rbbt/util/simpleopt'
require 'rbbt/workflow'
require 'rbbt/monitor'

$0 = "rbbt #{$previous_commands*""} #{ File.basename(__FILE__) }" if $previous_commands

options = SOPT.setup <<EOF

Report the status of the system

$ rbbt system status 

-u--uncomplete Print only uncompleted or error jobs
-h--help Print this help
EOF
rbbt_usage and exit 0 if options[:help]

uncomplete = options.delete :uncomplete

def pid_msg(pid)
  color = if pid and Misc.pid_exists? pid
            :green
          else
            :red
          end
  Log.color(color, pid || "missing")
end

def status_msg(status)
  color = case status
          when :error, :aborted, :missing
            :red
          when :streaming, :started
            :yellow
          when :done
            :green
          else
            if status.to_s.index ">"
              :yellow
            else
              nil
            end
          end
  Log.color(color, status.to_s)
end

locks = Rbbt.locks
sensiblewrites = Rbbt.sensiblewrites
persists = Rbbt.persists

puts Log.color(:magenta, "# System report")
puts
if locks.any?
  puts Log.color(:magenta, "Locks:")
  locks.sort_by{|f| File.exists?(f) ? File.ctime(f) : Time.now}.each do |lock|
    pid, ppid, time = Rbbt.load_lock(lock)
    time = File.exists?(lock) ? File.ctime(lock) : Time.now
    puts "  " << lock + Log.color(:blue, " -- time: #{Misc.format_seconds(Time.now - time)}; ppid: #{ppid}; pid: #{pid_msg pid}")
  end
  puts
end

if persists.any?
  puts Log.color(:magenta, "Persist:")
  persists.sort_by{|f| File.exists?(f) ? File.ctime(f) : Time.now}.each do |persist|
    time = File.exists?(persist) ? File.ctime(persist) : Time.now
    puts "  " << persist + Log.color(:blue, " -- time: #{Misc.format_seconds(Time.now - time)})")
  end
  puts
end

if sensiblewrites.any?
  puts Log.color(:magenta, "Writing:")
  sensiblewrites.sort_by{|f| File.exists?(f) ? File.ctime(f) : Time.now}.each do |sensiblewrite|
    pid, ppid, time = Rbbt.load_lock(sensiblewrite + '.lock')
    time = File.exists?(sensiblewrite) ? File.ctime(sensiblewrite) : Time.now
    puts "  " << sensiblewrite + Log.color(:blue, " -- time: #{Misc.format_seconds(Time.now - time)}; ppid: #{ppid}; pid: #{pid_msg pid}")
  end
  puts
end

jobs = Rbbt.jobs

puts Log.color(:magenta, "# Workflows")
puts
jobs.each do |workflow, tasks|
  tasks.each do |task, jobs|
    done = []
    other = {}
    jobs.each do |file,h|
      status = h[:status]
      if h[:status] == :done
        done << file
      else
        other[status||"missing"] ||= []
        other[status||"missing"] << [file, h[:pid]]
      end
    end
    next if uncomplete and other.empty?
    puts "* " << Log.color(:magenta, workflow) << "#" << Log.color(:yellow, task) << ": " << Log.color(:green, "done") << " " << done.length.to_s
    other.each do |status, list|
      files_txt = list.collect{|f,p| p.nil? ? f : (f + " (#{pid_msg p})") }
      puts "  " << status_msg(status) << ": " << (files_txt * ", ")
    end
  end
end

