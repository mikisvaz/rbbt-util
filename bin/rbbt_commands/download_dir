# vim: filetype=ruby :
require 'rbbt'
require 'cgi'
require 'rbbt/util/simpleopt'

options = SOPT.get("-lw--log_wget:-2--two_steps")

log_wget = options.delete :log_wget
two_steps = options.delete :two_steps

resource, directory, destination = ARGV
destination, directory = directory, '.' if destination.nil?

resource_server = Rbbt.etc.resource_server.read.chomp

url = File.join(resource_server, resource, 'get_directory?' + Misc.hash2GET_params(:directory => directory, :_format => 'raw'))

puts "Feching: #{ url }"

FileUtils.mkdir_p destination unless File.exists? destination
Dir.chdir destination

if two_steps
    `wget '#{url}' -c -O data.tar.gz && tar xvfz data.tar.gz`
else
    if log_wget
        `wget '#{url}' -O - |tar xfz -` 
    else
        `wget --quiet '#{url}' -O - |tar xvfz -` 
    end
end

